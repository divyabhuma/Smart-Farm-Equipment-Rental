<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Profile | FarmRent</title>
  <link rel="stylesheet" href="css/profile.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
    }

    body {
      background: #f9f9f9;
      margin: 0;
      padding: 0;
    }

    .header {
      background: #2e8b57;
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header .logo {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .header .nav a {
      margin-left: 1rem;
      color: white;
      text-decoration: none;
      font-weight: 500;
    }

    .profile-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }

    .profile-card {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
      width: 100%;
      max-width: 500px;
    }

    .profile-image img {
      border-radius: 50%;
      width: 120px;
      height: 120px;
      object-fit: cover;
      margin-bottom: 1rem;
    }

    .username {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .user-role {
      color: #777;
      margin-bottom: 1rem;
    }

    .profile-info p {
      margin: 0.5rem 0;
      font-size: 0.95rem;
    }

    .profile-actions .btn {
      display: inline-block;
      margin: 1rem 0.5rem 0;
      padding: 0.5rem 1rem;
      background: #2e8b57;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .edit-form {
      display: none;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }

    .edit-form input {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .edit-form label {
      text-align: left;
      font-weight: bold;
    }

    .footer {
      text-align: center;
      padding: 1rem;
      background: #eee;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <i class="fas fa-tractor"></i> <span>FarmRent</span>
    </div>
    <nav class="nav">
      <a href="index.html">Home</a>
      <a href="equipment.html">Equipment</a>
      <a href="logout.html">Logout</a>
    </nav>
  </header>

  <main class="profile-container">
    <div class="profile-card">
      <!-- Profile View -->
      <div id="profileView">
        <div class="profile-image">
          <img id="profilePic" src="https://i.pravatar.cc/150?img=32" alt="User Avatar" />
        </div>
        <h2 class="username" id="viewName">Divya Reddy</h2>
        <p class="user-role">Farmer</p>

        <div class="profile-info">
          <p><i class="fas fa-envelope"></i> <span id="viewEmail">divya@example.com</span></p>
          <p><i class="fas fa-phone"></i> <span id="viewPhone">+91 98765 43210</span></p>
          <p><i class="fas fa-map-marker-alt"></i> <span id="viewLocation">Andhra Pradesh, India</span></p>
        </div>

        <div class="profile-actions">
          <button class="btn" onclick="toggleEdit(true)">
            <i class="fas fa-user-edit"></i> Edit Profile
          </button>
          <a href="my-bookings.html" class="btn">
            <i class="fas fa-calendar-check"></i> My Bookings
          </a>
        </div>
      </div>

      <!-- Edit Profile Form -->
      <div id="editProfile" class="edit-form">
        <label>Profile Picture</label>
        <input type="file" id="profileImageInput" accept="image/*" onchange="previewImage()" />
        <img id="previewPic" src="https://i.pravatar.cc/150?img=32" alt="Preview" style="margin-top: 10px; width: 100px; border-radius: 50%;" />

        <label>Full Name</label>
        <input id="fullName" type="text" value="Divya Reddy" />

        <label>Email</label>
        <input id="email" type="email" value="divya@example.com" />

        <label>Phone</label>
        <input id="phone" type="text" value="+91 98765 43210" />

        <label>Location</label>
        <input id="location" type="text" value="Andhra Pradesh, India" />

        <div>
          <button type="button" class="btn" onclick="saveChanges()">Save Changes</button>
          <button type="button" class="btn" onclick="toggleEdit(false)">Cancel</button>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <p>&copy; 2024 FarmRent. All rights reserved.</p>
  </footer>

  <script>
    function toggleEdit(editing) {
      document.getElementById('profileView').style.display = editing ? 'none' : 'block';
      document.getElementById('editProfile').style.display = editing ? 'flex' : 'none';
    }

    function previewImage() {
      const input = document.getElementById('profileImageInput');
      const preview = document.getElementById('previewPic');

      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => preview.src = e.target.result;
        reader.readAsDataURL(input.files[0]);
      }
    }

    async function saveChanges() {
      const name = document.getElementById('fullName').value;
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      const location = document.getElementById('location').value;
      const imageFile = document.getElementById('profileImageInput').files[0];

      const formData = new FormData();
      formData.append('name', name);
      formData.append('email', email);
      formData.append('phone', phone);
      formData.append('location', location);
      if (imageFile) {
        formData.append('profileImage', imageFile);
      }

      const token = localStorage.getItem('token'); // Make sure it's stored on login

      try {
        const response = await fetch('/api/user/update', {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${token}` // ✅ Attach token here
          },
          body: formData
        });

        const result = await response.json();

        if (response.ok) {
          alert('✅ Profile updated successfully!');
          document.getElementById('viewName').textContent = name;
          document.getElementById('viewEmail').textContent = email;
          document.getElementById('viewPhone').textContent = phone;
          document.getElementById('viewLocation').textContent = location;

          if (result.profileImageUrl) {
            document.getElementById('profilePic').src = result.profileImageUrl;
          } else if (imageFile) {
            document.getElementById('profilePic').src = URL.createObjectURL(imageFile);
          }

          toggleEdit(false);
        } else {
          alert('❌ Update failed: ' + result.message);
        }
      } catch (error) {
        console.error('❌ Error:', error);
        alert('❌ Network error. Try again later.');
      }
    }
  </script>
</body>
</html>
